<!-- assign-product.component.html -->
<nz-modal
  [(nzVisible)]="isVisible"
  [nzTitle]="modalTitle"
  [nzWidth]="900"
  [nzOkText]="getOkButtonText()"
  [nzCancelText]="'Cancelar'"
  [nzOkLoading]="isSubmitting"
  [nzOkDisabled]="selectedProducts.length === 0"
  (nzOnOk)="onSubmit()"
  (nzOnCancel)="onCancel()"
  nzCentered
  class="assign-product-modal"
>

  <ng-container *nzModalContent>
    <div class="modal-content">
      
      <!-- Header con información de empresa -->
      <div class="modal-header">
        <div class="header-icon">
          <nz-icon nzType="shop" class="icon-assign"></nz-icon>
        </div>
        <div class="header-text">
          <h3>{{ modalTitle }}</h3>
          <p>Selecciona los productos que deseas asignar a <strong>{{ companyName }}</strong></p>
          <div class="selection-summary" *ngIf="selectedProducts.length > 0">
            <nz-tag nzColor="blue">
              {{ selectedProducts.length }} producto(s) seleccionado(s)
            </nz-tag>
          </div>
        </div>
      </div>

      <!-- Barra de búsqueda y filtros -->
      <div class="search-filters-section">
        <div class="search-row">
          <!-- Búsqueda principal -->
          <nz-input-group nzPrefixIcon="search" class="main-search">
            <input 
              type="text" 
              nz-input 
              [(ngModel)]="searchText"
              (ngModelChange)="onSearch()"
              placeholder="Buscar por nombre, SKU, marca o modelo..."
              autocomplete="off"
            />
          </nz-input-group>

          <!-- Limpiar selección -->
          <button 
            nz-button 
            nzType="default"
            (click)="clearSelection()"
            [disabled]="selectedProducts.length === 0"
            nz-tooltip="Limpiar selección"
          >
            <nz-icon nzType="clear"></nz-icon>
            Limpiar
          </button>
        </div>

        <div class="filters-row">
          <!-- Filtro por categoría -->
          <nz-select 
            [(ngModel)]="selectedCategoryFilter" 
            (ngModelChange)="onCategoryFilter()"
            nzPlaceHolder="Filtrar por categoría"
            class="category-filter"
            nzAllowClear
            nzShowSearch
          >
            <nz-option nzValue="all" nzLabel="Todas las categorías"></nz-option>
            <nz-option 
              *ngFor="let category of availableCategories" 
              [nzValue]="category.id" 
              [nzLabel]="category.name"
            ></nz-option>
          </nz-select>

          <!-- Filtro por estado -->
          <nz-select 
            [(ngModel)]="selectedStatusFilter" 
            (ngModelChange)="onStatusFilter()"
            nzPlaceHolder="Estado del producto"
            class="status-filter"
            nzAllowClear
          >
            <nz-option nzValue="all" nzLabel="Todos los estados"></nz-option>
            <nz-option nzValue="active" nzLabel="Productos activos"></nz-option>
            <nz-option nzValue="inactive" nzLabel="Productos inactivos"></nz-option>
          </nz-select>

          <!-- Toggle para mostrar solo productos no asignados -->
          <div class="filter-toggle">
            <nz-switch 
              [(ngModel)]="showOnlyUnassigned"
              (ngModelChange)="onUnassignedFilter()"
              [nzCheckedChildren]="checkedTemplate"
              [nzUnCheckedChildren]="uncheckedTemplate"
            ></nz-switch>
            <span class="toggle-label">Solo no asignados</span>
          </div>
        </div>
      </div>

      <!-- Lista de productos disponibles -->
      <div class="products-section">
        <div class="section-header">
          <h4>Productos Disponibles</h4>
          <div class="bulk-actions">
            <button 
              nz-button 
              nzType="default" 
              nzSize="small"
              (click)="selectAllVisible()"
              [disabled]="filteredProducts.length === 0"
            >
              Seleccionar todos
            </button>
            <button 
              nz-button 
              nzType="default" 
              nzSize="small"
              (click)="deselectAllVisible()"
              [disabled]="selectedProducts.length === 0"
            >
              Deseleccionar todos
            </button>
          </div>
        </div>

        <!-- Lista de productos con scroll -->
        <div class="products-list" [class.loading]="isLoadingProducts">
          <div 
            class="product-item" 
            *ngFor="let product of filteredProducts; trackBy: trackByProductId"
            [class.selected]="isProductSelected(product.id)"
            [class.already-assigned]="isProductAlreadyAssigned(product.id)"
          >
            <!-- Checkbox de selección -->
            <div class="product-checkbox">
              <label nz-checkbox 
                [ngModel]="isProductSelected(product.id)"
                (ngModelChange)="toggleProductSelection(product, $event)"
                [nzDisabled]="isProductAlreadyAssigned(product.id)"
              ></label>
            </div>

            <!-- Información del producto -->
            <div class="product-info" (click)="toggleProductSelection(product, !isProductSelected(product.id))">
              <div class="product-main">
                <div class="product-header">
                  <h5 class="product-name">{{ product.name }}</h5>
                  <div class="product-badges">
                    <nz-tag class="sku-tag">{{ product.sku }}</nz-tag>
                    <nz-tag 
                      [nzColor]="getProductStatusColor(product.status)"
                      class="status-tag"
                    >
                      {{ getProductStatusText(product.status) }}
                    </nz-tag>
                    <nz-tag 
                      *ngIf="isProductAlreadyAssigned(product.id)" 
                      nzColor="orange"
                      class="assigned-tag"
                    >
                      Ya asignado
                    </nz-tag>
                  </div>
                </div>

                <div class="product-details">
                  <div class="detail-row">
                    <span class="detail-label">Categoría:</span>
                    <span class="detail-value">{{ product.categoryName }}</span>
                  </div>
                  <div class="detail-row" *ngIf="product.brand">
                    <span class="detail-label">Marca:</span>
                    <span class="detail-value">{{ product.brand }}</span>
                  </div>
                  <div class="detail-row" *ngIf="product.model">
                    <span class="detail-label">Modelo:</span>
                    <span class="detail-value">{{ product.model }}</span>
                  </div>
                  <div class="detail-row" *ngIf="product.description">
                    <span class="detail-label">Descripción:</span>
                    <span class="detail-value">{{ product.description | slice:0:100 }}<span *ngIf="product.description.length > 100">...</span></span>
                  </div>
                </div>
              </div>

              <!-- Configuración inicial de stock -->
              <div 
                class="stock-config" 
                *ngIf="isProductSelected(product.id) && !isProductAlreadyAssigned(product.id)"
              >
                <h6>Configuración de Stock Inicial</h6>
                <div class="stock-inputs">
                  <nz-input-group nzPrefixIcon="inbox">
                    <input 
                      type="number" 
                      nz-input 
                      placeholder="Stock inicial"
                      min="0"
                      [(ngModel)]="getStockConfig(product.id).initialStock"
                    />
                  </nz-input-group>
                  <nz-input-group nzPrefixIcon="warning">
                    <input 
                      type="number" 
                      nz-input 
                      placeholder="Stock mínimo"
                      min="0"
                      [(ngModel)]="getStockConfig(product.id).minimumStock"
                    />
                  </nz-input-group>
                </div>
                <div class="stock-notes">
                  <textarea 
                    nz-input 
                    placeholder="Notas adicionales (opcional)"
                    [nzAutosize]="{ minRows: 2, maxRows: 3 }"
                    [(ngModel)]="getStockConfig(product.id).notes"
                  ></textarea>
                </div>
              </div>
            </div>
          </div>

          <!-- Estado de carga -->
          <div class="loading-state" *ngIf="isLoadingProducts">
            <nz-spin nzSimple [nzSize]="'large'"></nz-spin>
            <p>Cargando productos...</p>
          </div>

          <!-- Estado vacío -->
          <div class="empty-state" *ngIf="filteredProducts.length === 0 && !isLoadingProducts">
            <nz-empty 
              nzNotFoundImage="simple"
              [nzNotFoundContent]="emptyContentTemplate"
            ></nz-empty>
            
            <ng-template #emptyContentTemplate>
              <div class="empty-content">
                <h4>No se encontraron productos</h4>
                <p *ngIf="searchText">
                  No hay productos que coincidan con "{{ searchText }}"
                </p>
                <p *ngIf="!searchText && showOnlyUnassigned">
                  Todos los productos ya están asignados a esta empresa
                </p>
                <p *ngIf="!searchText && !showOnlyUnassigned">
                  No hay productos disponibles en el sistema
                </p>
              </div>
            </ng-template>
          </div>
        </div>
      </div>

      <!-- Resumen de selección -->
      <div class="selection-summary-section" *ngIf="selectedProducts.length > 0">
        <div class="summary-header">
          <h4>Productos Seleccionados ({{ selectedProducts.length }})</h4>
          <button 
            nz-button 
            nzType="link" 
            nzSize="small"
            (click)="clearSelection()"
          >
            Limpiar todo
          </button>
        </div>
        <div class="selected-products-list">
          <nz-tag 
            *ngFor="let productId of selectedProducts" 
            nzMode="closeable"
            (nzOnClose)="removeFromSelection(productId)"
            class="selected-product-tag"
          >
            {{ getProductById(productId)?.name }}
          </nz-tag>
        </div>
      </div>

      <!-- Templates para switch -->
      <ng-template #checkedTemplate>
        <nz-icon nzType="check"></nz-icon>
      </ng-template>
      
      <ng-template #uncheckedTemplate>
        <nz-icon nzType="close"></nz-icon>
      </ng-template>

    </div>
  </ng-container>

</nz-modal>